#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>

### enironment

set -o errexit  # always exit on  error
set -o pipefail # don't ignore exit codes when piping output

### configuration

BPLOG_PREFIX="buildpack.deno"
BUILD_DIR=${1:-}
CACHE_DIR=${2:-}
ENV_DIR=${3:-}
BP_DIR=$(cd "$(dirname "${0:-}")"; cd ..; pwd)

### 

exec 5>&1
OUTPUT=$(curl -fsSL https://deno.land/x/install/install.sh | bash | tee /dev/fd/5)
COMMAND=$(echo $OUTPUT | grep -oP 'export PATH=".*"')
echo $COMMAND
eval $COMMAND

echo "dirs"
echo $BUILD_DIR
echo $BP_DIR
echo $HOME

mkdir --parents "$BUILD_DIR/.heroku/deno"
mkdir --parents "$BUILD_DIR/.profile.d"

echo $(cd /app/.deno/bin && ls)

cp "$BP_DIR"/config/* "$BUILD_DIR/.profile.d/"
cp -r "$HOME/.deno/bin" "$BUILD_DIR/.heroku/deno"

echo "done!"
exit 0